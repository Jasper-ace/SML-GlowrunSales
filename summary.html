<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Summary</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-header bg-primary text-white text-center rounded-top-4">
        <h3 class="mb-0 fw-bold">üè¢ Department Sales Summary</h3>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover table-bordered align-middle text-center" id="deptTable">
            <thead class="table-success">
              <tr>
                <th scope="col">Department</th>
                <th scope="col">Total Sales</th>
                <th scope="col">Grand Total (‚Ç±)</th>
              </tr>
            </thead>
            <tbody>
              <!-- JS will load summary here -->
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-between mt-4">
          <a href="dashboard.html" class="btn btn-outline-secondary px-4">‚¨Ö Back to Dashboard</a>
          <div>
            <button class="btn btn-success px-4 me-2" onclick="loadSalesSummary()">üîÑ Refresh</button>
            <button class="btn btn-danger px-4" onclick="downloadPDF()">‚¨á Download PDF</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAFSdfPdf9URpjH-SgfX5xccgTIpXWIjj4",
      authDomain: "glowrun-sales.firebaseapp.com",
      projectId: "glowrun-sales",
      storageBucket: "glowrun-sales.appspot.com",
      messagingSenderId: "295519366546",
      appId: "1:295519366546:web:592af0e701eed3e828e54b",
      measurementId: "G-YER90NZLVD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        console.log("‚úÖ Logged in as:", user.email);
        await loadSalesSummary();
      }
    });

    // üìä Load Sales Summary
    async function loadSalesSummary() {
      const querySnapshot = await getDocs(collection(db, "entries"));
      let salesData = {};
      let overallTotal = 0;

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const dept = data.department || "Unknown";
        const quantity = Number(data.quantity) || 0;
        const unitPrice = Number(data.unitPrice) || 800;
        const amount = quantity * unitPrice;

        if (!salesData[dept]) {
          salesData[dept] = { count: 0, total: 0 };
        }

        salesData[dept].count += 1;
        salesData[dept].total += amount;
        overallTotal += amount;
      });

      const tbody = document.querySelector("#deptTable tbody");
      tbody.innerHTML = "";

      Object.entries(salesData).forEach(([dept, { count, total }]) => {
        const row = `
          <tr>
            <td class="fw-semibold">${dept}</td>
            <td>${count}</td>
            <td class="text-success fw-bold">‚Ç±${total.toLocaleString()}</td>
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", row);
      });

      const finalRow = `
        <tr class="table-info fw-bold">
          <td colspan="2">OVERALL TOTAL</td>
          <td>‚Ç±${overallTotal.toLocaleString()}</td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", finalRow);
    }

    // ‚¨á Download PDF function
    window.downloadPDF = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(14);
      doc.text("Department Sales Summary", 14, 15);

      // autoTable from HTML
      doc.autoTable({
        html: "#deptTable",
        startY: 25,
        theme: "grid",
        headStyles: { fillColor: [40, 167, 69] }, // green header
      });

      doc.save("Sales_Summary.pdf");
    };
  </script>
</body>
</html>
